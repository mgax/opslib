# Opslib Mailu Example

This example illustrates the deployment of a moderately complex application — a self-hosted email server — in its entirety. Plug in API keys to a handful of cloud services[^1], and you too can have a properly configured email server, up and running in minutes.

[^1]: We could have used AWS in place of Hetzner+Cloudflare+Backblaze, but where's the fun in that?

We're going to deploy [Mailu](https://mailu.io), on a [Hetzner](https://www.hetzner.com/) VPS, with [Cloudflare DNS](https://www.cloudflare.com/dns/) records, and daily [restic](https://restic.net/) backups to [Backblaze B2](https://www.backblaze.com/b2/cloud-storage.html).

### TL;DR

1. Clone the repo and [install opslib](https://pyopslib.readthedocs.io/en/latest/installation.html).
    ```shell
    git clone https://github.com/mgax/opslib
    cd opslib/examples/mailu
    pip install pyopslib
    ```
1. [Configure](#configuration) environment variables.
1. Deploy the stack.
    ```shell
    opslib - deploy
    ```
1. Create an initial admin user.
    ```shell
    opslib mailu run admin admin $MAILU_DOMAIN {PASSWORD}
    ```
1. Log into the web UI at `https://{MAILU_HOSTNAME}/admin`.

## Mailu

[Mailu](https://mailu.io) is a full mail server packaged as a set of container images.

The primary way to deploy Mailu is [with Docker Compose](https://mailu.io/2.0/compose/setup.html). Thete's a handy [configuration generator](https://setup.mailu.io/2.0/) that will ask a few questions and generate a `docker-compose.yml` file and a `mailu.env` file for environment variables. This example is based on such a configuration, but generates the compose and environment files itself, and copies them to the server.

Mailu will generate its own Letsencrypt certificates which it needs for https, smtp and imap.

Once Mailu is up, the stack interacts with its API, to figure out what DNS records it will set in Cloudflare.

## Hetzner VPS

The example creates a CX11 VPS (1 vCPU, 2GB memory, 20GB SSD, €4.51/month). Any SSH keys defined in the account will be added to the VPS. Its reverse DNS name will be set to `{MAILU_HOSTNAME}`.

## Cloudflare DNS

Cloudflare offers free [DNS hosting](https://www.cloudflare.com/dns/). This example requires a DNS zone configured in a Cloudflare account. It will set up:

* An `A` record for the VPS.
* An `MX` record for the mail domain.
* `TXT` records for SPF, DKIM and DMARC, generated by Mailu.
* Email client autoconfiguration records, also generated by Mailu.

To check that DNS is configured correctly, the stack provides a CLI command:

```
$ opslib dns check
dns MailDnsRecords [ok]
mailu.example.com. 600 IN MX 10 mailu.example.com.
mailu.example.com. 600 IN TXT "v=spf1 mx a:mailu.example.com ~all"
dkim._domainkey.mailu.example.com. 600 IN TXT "v=DKIM1; k=rsa; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA6Vrn9Jl/zhR55wXbCgvLq/NOF51oCG8dYZ/+kL6Uieodu2ofndM7syBL+rLuqiCyCK+LufQonlzSOhOM5pTQwQ1K3j5Ryn0+x7j3R+UtAELdYYWirAkuN6UDLHK8IknnnAAoeAziIW9up4X6c/8CMgofSSN0UzgZnjR3kgWsIanKSEn1ZSPRF+5LRbvlM2eV2w1N7k51ydtmknEvHt69uNdMBoqlLIU5VekrbNMtRZiXCcANhMPqYSzMWV7eiqsEOQuOW/blsolsMQLgF9LQ/07mbzWCgJKzz893EgFrMmDpB4lAQB0fwtFe9bewAUGW8tpnyrZ8RHKcDYjF0EV0pwIDAQAB"
_dmarc.mailu.example.com. 600 IN TXT "v=DMARC1; p=reject; rua=mailto:admin@mailu.example.com; ruf=mailto:admin@mailu.example.com; adkim=s; aspf=s"
mailu.example.com._report._dmarc.mailu.example.com. 600 IN TXT "v=DMARC1"
_imap._tcp.mailu.example.com. 600 IN SRV 20 1 143 mailu.example.com.
_pop3._tcp.mailu.example.com. 600 IN SRV 20 1 110 mailu.example.com.
_submission._tcp.mailu.example.com. 600 IN SRV 20 1 587 mailu.example.com.
_autodiscover._tcp.mailu.example.com. 600 IN SRV 10 1 443 mailu.example.com.
_submissions._tcp.mailu.example.com. 600 IN SRV 10 1 465 mailu.example.com.
_imaps._tcp.mailu.example.com. 600 IN SRV 10 1 993 mailu.example.com.
_pop3s._tcp.mailu.example.com. 600 IN SRV 10 1 995 mailu.example.com.
autoconfig.mailu.example.com. 600 IN CNAME mailu.example.com.
```

## Backups

Altough Hetzner offers backups for the VPS, we'd like to have finer grained and longer lived backups, so we set up [restic](https://restic.net/), with a daily systemd timer job.

When the stack is deployed, it will create a Backblaze B2 bucket and access key, and initialize a restic repository in it.

There is a CLI wrapper for the `restic` command so we can easily inspect the repository:

```
$ opslib backups.restic run snapshots
repository 0e64d118 opened (version 1)
ID        Time                 Host                  Tags        Paths
---------------------------------------------------------------------------------------
[...]

c14b46d7  2023-04-19 06:00:04  opslib-example-mailu              /opt/volumes/data
                                                                 /opt/volumes/mail
                                                                 /opt/volumes/mailqueue
                                                                 /opt/volumes/redis
                                                                 /opt/volumes/webmail

da2fb908  2023-04-20 06:00:02  opslib-example-mailu              /opt/volumes/data
                                                                 /opt/volumes/mail
                                                                 /opt/volumes/mailqueue
                                                                 /opt/volumes/redis
                                                                 /opt/volumes/webmail
---------------------------------------------------------------------------------------
9 snapshots
```

Dumping a snapshot as a Tar archive is easy:

```
$ opslib backups.restic run dump latest / | tar t
opt/
opt/volumes/
opt/volumes/data/
opt/volumes/data/instance
opt/volumes/data/main.db
opt/volumes/mail/
opt/volumes/mail/admin@mailu.example.com/
opt/volumes/mail/admin@mailu.example.com/.Drafts/
opt/volumes/mail/admin@mailu.example.com/.Drafts/cur/
opt/volumes/mail/admin@mailu.example.com/.Drafts/maildirfolder
[...]
```

The systemd unit component also provides its own CLI, which can be used to inspect journald logs:

```
$ opslib backups.backup_cron.service journalctl --since today
-- Journal begins at Sat 2023-04-15 11:34:19 UTC, ends at Thu 2023-04-20 14:23:07 UTC. --
Apr 20 03:00:02 opslib-example-mailu systemd[1]: Starting mailu-backup-daily.service...
Apr 20 03:00:05 opslib-example-mailu backup[282160]: unable to open cache: unable to locate cache directory: neither $XDG_CACHE_HOME nor $HOME are defined
Apr 20 03:00:18 opslib-example-mailu backup[282160]: Files:           0 new,     1 changed,    22 unmodified
Apr 20 03:00:18 opslib-example-mailu backup[282160]: Dirs:            0 new,     3 changed,    50 unmodified
Apr 20 03:00:18 opslib-example-mailu backup[282160]: Added to the repo: 3.218 KiB
Apr 20 03:00:18 opslib-example-mailu backup[282160]: processed 23 files, 402.725 KiB in 0:12
Apr 20 03:00:18 opslib-example-mailu backup[282160]: snapshot da2fb908 saved
Apr 20 03:00:18 opslib-example-mailu systemd[1]: mailu-backup-daily.service: Succeeded.
Apr 20 03:00:18 opslib-example-mailu systemd[1]: Finished mailu-backup-daily.service.
Apr 20 03:00:18 opslib-example-mailu systemd[1]: mailu-backup-daily.service: Consumed 1.520s CPU time.
```

To simplify teardown of the example, there's a command to empty the B2 bucket, otherwise it would not be possible to delete it:

```
$ opslib backups empty-bucket
```

## Configuration

The stack expects a few environment variables to be defined. [direnv](https://direnv.net/) is a good way to configure them; see [the tutorial](https://pyopslib.readthedocs.io/en/latest/tutorial/layout.html) for an example.

```env
CLOUDFLARE_API_TOKEN=[...] # https://developers.cloudflare.com/fundamentals/api/get-started/create-token/
CLOUDFLARE_ZONE_NAME=example.com
HCLOUD_TOKEN=[...] # https://docs.hetzner.com/cloud/api/getting-started/generating-api-token
B2_APPLICATION_KEY_ID=[...] # https://www.backblaze.com/b2/docs/application_keys.html
B2_APPLICATION_KEY=[...]
MAILU_HOSTNAME=mailu.example.com
MAILU_DOMAIN=example.com
RESTIC_PASSWORD=[...] # create a random password: `python3 -c "import secrets; print(secrets.token_urlsafe())"`
```

Make sure the Cloudflare token has "Zone - DNS - Edit" permission.

### Mailu domain and hostname

`MAILU_DOMAIN` refers to the domain where email addresses reside, e.g. `admin@example.com` has the domain `example.com`.

`MAILU_HOSTNAME` refers to the hostname of the mail server. This is where you connect to send and receive mail, and perform server administration. It's not unusual to have a subdomain of the mail domain, e.g. `mailu.example.com` or `mailserver.example.com`.

## Deployment

```shell
opslib - deploy
```

At some point, the _deploy_ command will try to call the Mailu API (which takes a while to spin up, it has to fetch Letsencrypt certificates first) and fail with the message `<MailuDomain mailu.domain>: Mailu API not available`. Re-run the command until it succeeds.

Then, create an initial admin user[^2]. Replace `{PASSWORD}` with an initial password.

[^2]: Yes, there are two `admin`s in that command: the mailu _admin_ subcommand which creates a user, and the _admin_ username of the new user.

```shell
opslib mailu run admin admin $MAILU_DOMAIN {PASSWORD}
```

Then go to the web admin at `https://{MAILU_HOSTNAME}/admin`, log in, and change the password from the _Update password_ link in the menu on the left.
